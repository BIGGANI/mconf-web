$(function() {

  if (isOnPage('spaces', 'new|create')) {

    setNewLogo = function(img) {
      $("#selected-logo-image").attr('src', img);

      // the hidden field that defines the image selected
      img = img.replace("/assets", "");
      $("#space_image").attr('value', img);
    }

    // when clicking in a logo in the gallery
    $("#logos-gallery a").on("click", function(e) {
      e.preventDefault();
      img = $(this).find("img").attr("src");
      setNewLogo(img);
    });

    // when clicking in a text-genrated logo
    $(document).on("click", "#logos-text-generated a", function(e) {
      e.preventDefault();
      img = $(this).find("img").attr("src");
      setNewLogo(img);
    });

    var dateTime = new Date();
    var rand = dateTime.getHours() + "" + dateTime.getMinutes() + "" + dateTime.getSeconds() + "" + dateTime.getMilliseconds();

    // TODO: why do we need these rands?
    $("#logo_rand").attr('value', rand);
    $("#space_rand_value").attr('value', rand);

    $(document).on("click", "#logos-text-submit", function(e) {
      e.preventDefault();
      $.get('/logos/new?text='+ ($("#logos-text-input").val()) + '&rand_name=' + rand , function(data) {
        $('#logos-text-generated').html(data);
      });
    });

    // TODO: not finished
    $(document).on("crop-window-shown", function() {
      $('#crop-form').ajaxForm({
        success: function() {
          setNewLogo("/assets/" + "tmp/" + rand + "/uploaded_logo.png?" + (new Date()).getTime());
          mconf.Modal.closeWindows();
        }
      });
    });

// ajaxForm({
//       beforeSubmit:function() {
//         $("#selected_logo_image").attr('src', "");
//       },
//       target: '#resultado',
//       success: function() {
//         alert('lalala');
//         $('#resultado').fadeIn('slow');
//         $("#space_image").attr('value', "tmp/" + rand + "/uploaded_logo.png");
//         $("#selected_logo_image").attr('src', "/assets/" + "tmp/" + rand + "/uploaded_logo.png?" + (new Date()).getTime());
//         mconf.Modal.closeWindows();
//         closeUploadLogo();
//       }
//     });



  /*
  if ($("#create_space #public").is(':checked')) {
    $('#new_space_webconf_area').hide();
    $('#moderatorPW').attr('disabled', true);
    $('#attendeePW').attr('disabled', true);
  } else {
    $('#new_space_webconf_area').show();
    $('#moderatorPW').removeAttr('disabled');
    $('#attendeePW').removeAttr('disabled');
  }

  // function executed after the crop fancy box is shown
  // TODO: crop with modal window
  onCropLogoFormSuccess = function() {
    $('#crop_logo_form').ajaxForm({
      beforeSubmit:function() {
        $("#selected_logo_image").attr('src', "");
      },
      target: '#resultado',
      success: function() {
        $('#resultado').fadeIn('slow');
        $("#space_image").attr('value', "tmp/" + rand + "/uploaded_logo.png");
        $("#selected_logo_image").attr('src', "/assets/" + "tmp/" + rand + "/uploaded_logo.png?" + (new Date()).getTime());
        mconf.Modal.closeWindows();
        closeUploadLogo();
      }
    });
  }


  selectGeneratedImage = function(image){
        $("#space_image").attr('value', image);
        $("#selected_logo_image").attr('src', "/assets/" + image + "?" + (new Date()).getTime());
  }

  closeTextLogo = function(){
        $("#default_text_logo").hide(0);
        $("#open_text_logo_link").show();
        $("#close_text_logo_link").hide();
  }

  openTextLogo = function(){
        $("#default_text_logo").show(0);
        $("#open_text_logo_link").hide();
        $("#close_text_logo_link").show();
  }

  closeGallery  = function (){
        $("#default_space_images").hide(0);
        $("#open_gallery_link").show();
        $("#close_gallery_link").hide();
  }

  openGallery  = function (){
         $("#default_space_images").show(0);
         $("#close_gallery_link").show();
         $("#open_gallery_link").hide();
  }

  closeUploadLogo = function(){
        $("#default_upload_logo").hide(0);
        $("#open_upload_logo_link").show();
        $("#close_upload_logo_link").hide();
  }

  openUploadLogo  = function (){
        $("#default_upload_logo").show(0);
        $("#open_upload_logo_link").hide();
        $("#close_upload_logo_link").show();
  }



  $("#create_space #public").livequery('click', function(event) {
    $('#new_space_webconf_area').toggle(0);
    if ($(this).is(':checked')) {
      $('#moderatorPW').attr('disabled', true);
      $('#attendeePW').attr('disabled', true);
    } else {
      $('#moderatorPW').removeAttr('disabled');
      $('#attendeePW').removeAttr('disabled');
    }
  });

  $("#create_space #hideMPW").livequery('click', function(event) {
    if ($(this).is(':checked')) {
      mconf.ShowablePassword.changeInputType("#moderatorPW", 'text');
    }
    else {
      mconf.ShowablePassword.changeInputType("#moderatorPW", 'password');
    }
  });

  $("#create_space #hideAPW").livequery('click', function(event) {
    if ($(this).is(':checked')) {
      mconf.ShowablePassword.changeInputType("#attendeePW", 'text');
    }
    else {
      mconf.ShowablePassword.changeInputType("#attendeePW", 'password');
    }
  });
  */

  }

});
