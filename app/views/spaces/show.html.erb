<% menu(:home) %>

<% content_for :javascript do  %>
  $(".news_navigation_link").livequery("click", function(){
	  var route = $(this).attr("href");
		$(this).attr("href","#")
	  $.get(route,
            {authenticity_token: "<%=form_authenticity_token()%>"},
            function(data){
              $("#last_news").replaceWith(data);
            }
          );
	});
	
	$("#join_form").submit(function(){
    var route = $(this).attr("action");
    $.post(route,
            {authenticity_token: "<%=form_authenticity_token()%>"},
            function(data){
              eval(data);
            }
          );
    return false;
  });

	title = "<%=t('search.dots')%>";
	$("#query").click(function(){
	  if(this.value == title){
		  this.value= "";
		}
	});
	
	$("#query").blur(function(){
	  if(this.value == ""){
		  this.value= title;
		}
	});
	
	$(".fancybox_link").fancybox({
    'hideOnContentClick' : false
  });
	
<% end %>

<% content_for :search do  %>
  <% form_tag(search_all_path(@space), :method => 'get') do %>
			<%= text_field_tag 'query',(params[:query] ? params[:query] :  t('search.dots') )%>
     <button type="submit"><%=t("button.go")%></button>
  <% end %>
<%end%>

<% content_for :sidebar do  %>
  <div id="join">
  <% if space.users.include?(current_user) && !is_last_admin(@space, @performance.first)%>
		<%= link_to "<button class='leave-space'>"+t('space.leave')+"</button>", space_performance_path(@space, @performance), :method => :delete, :title => t('space.leave'), :confirm => t('space.confirm') %>
  <%elsif !is_last_admin(@space, @performance.first)%>
	  <%if logged_in? && space.public?%>
		<% form_tag space_join_requests_path(space), :id => "join_form" do %>
		  <button class="join-space" type:"submit"><%=t('space.join')%></button>
	    <% end %>
		<%else%>
  		  <%=link_to "<button class='join-space'>"+t('space.join')+"</button>", new_space_join_request_path(space), :class => "fancybox_link" %>
		<%end%>
  <% end %>
	</div>
  <div class="space-desc">

	  <h3><%=t("space.about")%> <em><%=@space.name%></em></h3>

	<p><%=image_tag(logo_image_path(@space, :size =>'h48'), :align => "left")%>
	<%= sanitize(space.description) if space.description.present? %></p>
  </div>	
	<div id="inc-events">
     <h3><span><%=link_to(image_tag("icons/feed.png",:class=>"icon", :alt => t('RSS'), :title => t('RSS') ),space_events_path(@space,:format => :atom))%></span><%=image_tag("icons/date.png",:class=>"icon")%> <%=link_to t('event.upcoming.other'), space_events_path(@space)%></h3>
		 <ul>
		 	<%if @upcoming_events.empty?%>
			  <p><%= t('event.upcoming.none') %></p>
			<%else%>
			  <% for event in @upcoming_events -%>
          <li class="event">
            <%event_link="<h5 class="'unified_event'">" + sanitize(event.title) + "</strong></h5> <span class='sidebar_date small-font'>" + event.start_date.to_formatted_s(:short) + " - " + event.end_date.to_formatted_s(:short) + "(GMT "+  Time.zone.formatted_offset + ")</span>"%>
            <%=link_to event_link, space_event_path(@space,event)%>
            <%=link_to "", space_event_path(@space,event),:class=>"box-link"%>
          </li>
        <% end -%>
			<%end%>  
		 </ul> 
		 
		 <div class="read_more margin-up">
		 	<!--<img src="../images/icons/16/arrow5.png"></img>-->
		   <%= link_to "Read more", space_events_path(@space), :class => "read_more_link" if space.authorize?([:read, :content], :to => current_user) %>
		   
		 </div>
  </div>
<% end %>

<% if !@current_events.empty? %>
  <div id="home_current_events">   
  	<ul>
  		<li><h3><%=link_to t('event.now'), space_events_path(@space)%></h3></li>
  		<%for event in @current_events do%>
  		  <li class="margin-up">
  		  	<h3><%=image_tag("icons/date.png",:class=>"icon")%> <%=link_to(event.name,space_event_path(@space,event),:class=>"unified_event")%></h3> 			
		  </li><li>	
			<span class='small-font main_text'><%= event.start_date.to_formatted_s(:short)%> - <%=event.end_date.to_formatted_s(:short)%> (<%= t('GMT') %> <%=Time.zone.formatted_offset%> )</span>
		  </li>
		<%end%>
  	</ul>
  </div>
<% end %>

<% if @news_to_show %>
  <div id="latest_news">
	  <h3><%=image_tag("icons/newspaper.png")%> <%= t('latest_news') %></h3>
    <%= render :partial => 'last_news' %>
</div>
<% end %>

<div id="latest_posts">
    <h3><span><%=link_to(image_tag("icons/feed.png",:class=>"icon",:alt=>t('RSS'),:title=>t('RSS')),space_posts_path(@space,:format=> :atom))%></span><%=image_tag("icons/comment.png")%><%=link_to t('post.latest'),space_posts_path(@space)%></h3>
	  <%if @lastest_posts.empty?%>
	     <br/><p class="main_text"><%= t('post.none_recent') %></p>
	  <%else%>
	    <%last_post = @lastest_posts.last%>
	    <% for post in @lastest_posts -%>
		  <div class="thread post <%= 'last' if (post == last_post)%>" >
	      	<div class="thread_content">
			  <div class="post-logo">
			    <%if post.author.authorize?([:read, :profile],:to=> current_user)%>	
				  <%= link_logo(post.author, :size => 32, :url => user_profile_path(post.author), :title=>post.author.name) %>
			    <%else%>
			      <%=logo(post.author, :size=>32, :title=>post.author.name)%>
			    <%end%>
			  </div>
			  <div class="thread-title-wrapper">
			  	<ul class="thread-title">      
			      	<li>
			      	   <%if post.author.authorize?([:read, :profile],:to=> current_user)%>
				         <span class="unified_user"><%=link_to(post.author.name,user_profile_path(post.author),:class=>"unified_user")%>:</span> 
					  <%else%>
					    <span class="unified_user"><%=post.author.name%>: </span> 
					  <%end%>
					  <%=link_to(first_words(post.title, 40), space_post_path(@space,post),:class=>"unified_posts")%>
					  <%if has_attachments(post)%>
					    <%=image_tag("icons/attach.png",:title=>attachment_name(post),:class=>"icon")%>
					  <%end%>
					  <span class="updated"><%= t('updated_time_ago', :time => time_ago_in_words(post.updated_at)) %></span>
					</li>	     
					<li>
						<div class="main_text">
							<%=first_words(strip_tags(post.text),90)%>
						</div>
					</li>	    
			    </ul>
			  </div>
			</div>
		  </div>		  
		  <!--<div class="post">
	        <%=link_to sanitize(post.title),space_post_path(@space,post),:class=>"unified_posts"%> <span class="updated"><%=link_to( t('updated_time_ago', :time => time_ago_in_words(post.updated_at) ),space_post_path(@space, post))%></span>
	        <a href=<%=space_post_path(@space, post)%> class="box-link"></a>
	      </div>-->
	    <% end -%>
	    <div class="read_more"> 
	      <%= link_to t('read_more'), space_posts_path(@space), :class => "read_more_link" if space.authorize?([:read, :content], :to => current_user)%>
	    </div>
	  <%end%>     
</div>

<div id="latest_users">
  <h3><%=image_tag("icons/user.png")%> <%=link_to t('user.recent_join'), space_users_path(@space)%> </h3>
  <%last_user = @lastest_users.last%>
  <% for user in @lastest_users -%>

    <div class="user <%= 'last' if (user == last_user)%>">
    	<%if user.authorize?([:read, :profile],:to=> current_user)%>
			
			<div class="post-logo"><%=link_to logo(user, :size=>32, :title=>user.name),user_profile_path(user)%></div>
			<div>
			  <ul>
			    <li><%=link_to sanitize(user.full_name),user_profile_path(user),:class=>"unified_user"%></li>
			    <li><%=link_to sanitize(user.organization),user_profile_path(user),:class=>"small-font main_text" %></li>
			  </ul>
			</div>
			
		<%else%>
			<div class="post-logo"><%=logo(user, :size=>32, :title=>user.name)%></div>
        	<div>
          	  <ul>
            	<li class="unified_user"><%=sanitize(user.full_name)%></li>
            	<li class="small-font main_text"><%=sanitize(user.organization) %></li>
          	  </ul>
         	</div>
		<%end%>        
    </div>
  <% end -%>
  <div class="read_more">
    <%= link_to t('read_more'), space_users_path(@space), :class => "read_more_link" if space.authorize?([:read, :performance], :to => current_user)%>
  </div>
</div>

<div id="lightbox_content" style="display:none"></div>
