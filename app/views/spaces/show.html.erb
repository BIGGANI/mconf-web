<% menu(:home) %>

<% content_for :javascript do  %>
  $(".news_navigation_link").livequery("click", function(){
	  var route = $(this).attr("href");
		$(this).attr("href","#")
	  $.get(route,
            {authenticity_token: "<%=form_authenticity_token()%>"},
            function(data){
              $("#last_news").replaceWith(data);
            }
          );
	});
	
	$("#join_form").submit(function(){
    var route = $(this).attr("action");
    $.post(route,
            {authenticity_token: "<%=form_authenticity_token()%>"},
            function(data){
              eval(data);
            }
          );
    return false;
  });
	
	$("#query").click(function(){
	  if(this.value == "Search..."){
		  this.value="";
		}
	});
	$(".fancybox_link").fancybox({
    'hideOnContentClick' : false
  });
	
<% end %>

<% content_for :search do  %>
  <% form_tag(search_all_path(@space), :method => 'get') do %>
			<%= text_field_tag 'query',(params[:query] ? params[:query] :  t('search.dots') )%>
      <%= image_submit_tag "buttons/search.png"%>
  <% end %>
<%end%>

<% content_for :sidebar do  %>
  <div id="join">
  <% if space.users.include?(current_user)%>
		<%= link_to "<button class='leave-space'>"+t('space.leave')+"</button>", space_performance_path(@space, @performance), :method => :delete, :title => t('space.leave'), :confirm => t('space.confirm') %>
  <%else%>
	  <%if logged_in? && space.public?%>
		<% form_tag space_join_requests_path(space), :id => "join_form" do %>
		  <button class="join-space" type:"submit"><%=t('space.join')%></button>
	    <% end %>
		<%else%>
  		  <%=link_to "<button class='join-space'>"+t('space.join')+"</button>", new_space_join_request_path(space), :class => "fancybox_link" %>
		<%end%>
  <% end %>
	</div>
  <div class="space-desc">

	  <h3>About <em><%=@space.name%></em></h3>

	<p><%=image_tag(logo_image_path(@space, :size =>'h48'), :align => "left")%>
	<%= sanitize(space.description) if space.description.present? %></p>
  </div>	
	<div id="inc-events">
     <h3><span><%=link_to (image_tag("icons/feed.png",:class=>"icon", :alt => t('RSS'), :title => t('RSS') ),formatted_space_events_path(@space,:atom))%></span><%=image_tag("icons/date.png",:class=>"icon")%><%=link_to t('event.upcoming.other'), space_events_path(@space)%></h3>
		 <ul>
		 	<%if @upcoming_events.empty?%>
			  <p><%= t('event.upcoming.none') %></p>
			<%else%>
			  <% for event in @upcoming_events -%>
          <li class="event">
            <%event_link="<h5 class="'up-event'">" + sanitize(event.title) + "</strong></h5> <span class='small-font'>" + event.start_date.to_formatted_s(:short) + " - " + event.end_date.to_formatted_s(:short) + "(GMT "+  Time.zone.formatted_offset + ")</span>"%>
            <%=link_to event_link, space_event_path(@space,event)%>
            <%=link_to "", space_event_path(@space,event),:class=>"box-link"%>
          </li>
        <% end -%>
			<%end%>  
		 </ul> 
		 <br/>
		 <div class="read_more">
		 	<img src="../images/icons/reply.png"></img>
		   <%= link_to "Read more", space_events_path(@space), :class => "read_more_link" if space.authorize?([:read, :content], :to => current_user) %>
		   
		 </div>
  </div>
<% end %>

<% if !@current_events.empty? %>
  <div id="home_current_events">
    <h3><%=image_tag("icons/date.png",:class=>"icon")%> <%=link_to t('event.now'), space_events_path(@space)%></h3>
  	<ul>
  		<%for event in @current_events do%>
  		  <li>
  		  	<%=link_to "<h5>#{event.name}</h5>", space_event_path(@space,event)%>
			<span class='small-font'><%= event.start_date.to_formatted_s(:short)%> - <%=event.end_date.to_formatted_s(:short)%> (<%= t('GMT') %> <%=Time.zone.formatted_offset%> )</span>
		  </li>
		<%end%>
  	</ul>
  </div>
<% end %>

<% if @news_to_show %>
  <div id="latest_news">
	  <h3><%=image_tag("icons/information.png")%> <%= t('latest_news') %></h3>
    <%= render :partial => 'last_news' %>
</div>
<% end %>

<div id="latest_posts">
    <h3><span><%=link_to (image_tag("icons/feed.png",:class=>"icon",:alt=>t('RSS'),:title=>t('RSS')),formatted_space_posts_path(@space,:atom))%></span><%=image_tag("icons/comment.png")%><%=link_to t('post.latest'), space_posts_path(@space)%></h3>
	  <%if @lastest_posts.empty?%>
	     <br/><p><%= t('post.none_recent') %></p>
	  <%else%>
	    <% for post in @lastest_posts -%>
	      <div class="post">
	        <strong><%=link_to sanitize(post.title),space_post_path(@space, post)%></strong><span class="updated"><%=link_to ( t('updated_time_ago', :time => time_ago_in_words(post.updated_at) ),space_post_path(@space, post))%></span>
	        <a href=<%=space_post_path(@space, post)%> class="box-link"></a>
	      </div>
	    <% end -%>
	    <div class="read_more"> 
	      <%= link_to t('read_more'), space_posts_path(@space), :class => "read_more_link" if space.authorize?([:read, :content], :to => current_user)%>
	    </div>
	  <%end%>     
</div>

<div id="latest_users">
  <h3><%=image_tag("icons/user.png")%><%=link_to t('user.recent_join'), space_users_path(@space)%> </h3>
  <% for user in @lastest_users -%>
    <div class="user">
    	<%if user.authorize?([:read, :profile],:to=> current_user)%>
			<%=link_to ("", user_profile_path(user),:class=>"box-link")%>
			<div><%=link_to logo(user, :size=>32, :title=>user.name),user_profile_path(user)%></div>
			<div>
			  <ul>
			    <li><strong><%=link_to sanitize(user.full_name),user_profile_path(user),:class=>"u_name"%></strong></li>
			    <li><%=link_to sanitize(user.organization),user_profile_path(user),:class=>"small-font" %></li>
			  </ul>
			</div>
			<%=link_to ("", user_profile_path(user),:class=>"box-link")%>
		<%else%>
			<div><%=logo(user, :size=>32, :title=>user.name)%></div>
        	<div>
          	  <ul>
            	<li class="u_name"><strong><%=sanitize(user.full_name)%></strong></li>
            	<li class="small-font"><%=sanitize(user.organization) %></li>
          	  </ul>
         	</div>
		<%end%>        
    </div>
  <% end -%>
  <div class="read_more">
    <%= link_to t('read_more'), space_users_path(@space), :class => "read_more_link" if space.authorize?([:read, :performance], :to => current_user)%>
  </div>
</div>

<div id="lightbox_content" style="display:none"></div>
