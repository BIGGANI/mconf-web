<% content_for :headers do%>
  <%= javascript_include_tag 'jquery.jeditable', 'jquery.filestyle','jquery.jcrop' %>
<%end%>

<% content_for :javascript do%>
  $("#nonjavascript_form").remove();
	$("#jedit_form").show();
	$('#space_name').editable(function(value, settings){
         $.post("<%=space_path(@space)%>",{
           _method: "put", authenticity_token: "<%=form_authenticity_token()%>", 'space[name]': value          
         }, function(data){
				   eval(data);
					 return(data);
				 });
			 },{
			 tooltip   : 'Click to edit...',
			 width : 185
   });
	 
	 $('#space_name form input').livequery("blur",function(){
     $('#edit_name_icon').show();
   });
   
   $('#space_name').livequery("click",function(){
     $('#edit_name_icon').hide();
   });

  $('#space_description').editable('<%=space_path(@space)%>', {
         method : 'PUT',
				 type : 'textarea',
				 cancel    : 'Cancel',
         submit    : 'OK',
         indicator : '<img src="ui/icons/accept.png" />',
         tooltip   : 'Click to edit...',
         name : 'space[description]',
				 width : 185,
				 height : 90,
         submitdata : {authenticity_token: "<%=form_authenticity_token()%>"},
				 callback : function(value, settings) {
           $('#edit_description_icon').show();
        }
   });
	 
	 $('#space_description form textarea').livequery("blur",function(){
	   $('#edit_description_icon').show();
	 });
	 
	 $('#space_description').livequery("click",function(){
     $('#edit_description_icon').hide();
   });
	 
	 edit_name = function(){
	   $('#space_name').click();
		 $('#edit_name_icon').hide();
	 };
	 
	 edit_description = function(){
     $('#space_description').click();
     $('#edit_description_icon').hide();
   };
	 
	 $("#public_checkbox").click(function () { 
	    var val = $(this).is(":checked");
      $.post("<%=space_path(@space)%>",{
        _method: "put", authenticity_token: "<%=form_authenticity_token()%>", 'space[public]': val          
      });
    });
		
		edit_logo_fun = function(){
		  $('#update_logo').show();
			$('#edit_logo').parent().hide();
			style_file_input();
			
			$("form#update_logo").attr("action","<%=precrop_space_logo_path(@space.id)%>");
			$("form#update_logo input[type=hidden][name=_method][value=put]").remove();
		};
		

  $("form#update_logo").ajaxForm(function(data) {
    
    $("#for_lightbox").append(data);
    
    $("<a href=#for_lightbox></a>").fancybox({
      'hideOnContentClick' : false,
      'frameWidth' : 200,
      'frameHeight' : 200,
      'callbackOnShow' : function(){
          $("#for_lightbox").children().remove();
          var size;
          if ($("#croplogo").attr("width")<$("#croplogo").attr("height")){
            size = $("#croplogo").attr("width");
          }else{
            size = $("#croplogo").attr("height");
          }     
          $("#croplogo").Jcrop({
            onSelect: cropImage,
            onChange: cropImage,
            aspectRatio: <%=Logo::ASPECT_RATIO_S%>,
            setSelect: [size/4,size/4,3*size/4,3*size/4]
          });
          if ($("#croplogo").height() +105 >200){
            $("#fancy_outer").height($("#croplogo").height() + 105);
          }
          if ($("#croplogo").width()+30 > 200){
            $("#lightbox-logo").width($("#croplogo").width()-18);
            $("#fancy_outer").width($("#croplogo").width()+30);
          }
        }
    }).click(); 
  });
	
	$("form#update_logo input[type=image]").click(function(){
		  if($("#logo_media").val()==""){
		    alert("Select an image, please");
				return false;
		  }
	});
  
   function cropImage (c){
    $("#crop_size_x").val(c.x);
    $("#crop_size_y").val(c.y);
    $("#crop_size_height").val(c.h);
    $("#crop_size_width").val(c.w);
    // c.x, c.y, c.x2, c.y2, c.w, c.h

  };
	 
<%end%>

<div id="space-conf">

<h3>Space configuration</h3>

<div id="nonjavascript_form">
	<% form_for @space, :html => { :multipart => true} do |f| %>
		
		<p>
		  <label for="name">Name</label>
		  <%= f.text_field :name %>
		</p>
		
		<p>
		  <label for="description">Description</label><br/>
		  <%= f.text_area :description%>
		</p>
	
		<p>
		  <label for="public">Allow public access?</label> 
		  <%= check_box("space", "public")%>
		</p>
		
	  <p>
	    <%= image_submit_tag "buttons/update.png"%>
	  </p>
	
	<% end %>
	<h3>Space logo</h3>
	 <% form_for :logo, :url => space_logo_path(@space.id),:html => { :multipart => true } do |f| %>
	  
    <p><%= f.file_field :media %></p>
    <p><%= image_submit_tag 'buttons/update.png' %></p>
  <%end%>
</div>

<div id="jedit_form" style="display:none">
  <div>
    <label for="name">Name:</label>
	<span id="space_name"><%=@space.name%></span> <%= link_to_function image_tag("icons/pencil.png", :alt => "edit",:class=>"icon" ), "edit_name()", :id => "edit_name_icon"%>
  </div>
  <div>
	 <label for="description">Description:</label><br/>
	 <span id="space_description"><%=@space.description%></span> <%= link_to_function image_tag("icons/pencil.png", :alt => "edit",:class=>"icon" ), "edit_description()", :id => "edit_description_icon"%>
  </div>
  <div>
    <label for="public">Allow public access:</label> 
    <%= check_box_tag "space[public]", true, @space.public?, :id => "public_checkbox"%>
  </div>
	<div>
		<label for="public">Click to change your logo:</label> 
		<%= link_to_function logo(@space, :size => 'h128'), "edit_logo_fun()", :id => "edit_logo"%>
	</div>

	<% form_for :logo, :url => space_logo_path(@space.id),:html => { :multipart => true, :id => "update_logo", :style => "display:none" } do |f| %>
	  <p><%= f.file_field :media %></p>
    <p><%= image_submit_tag 'buttons/update.png' %></p>
  <%end%>
		
</div>

<%= link_to "Delete space", space_path(@space), :confirm => 'Are you sure?', :method => :delete,:title => "Delete space" %>

</div>

<div id="for_lightbox" style="display:none"></div>