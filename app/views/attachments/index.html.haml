- spaces_menu_at :repository
= include_gon
= render :partial => 'spaces/menu'

= content_for :headers do
  :javascript
    $(document).ready(function() {
      //Upload form
      hide_table = function(){
        $("#doc_repository").parent().html();
        teste = I18n.t('repository.loading');
      }

      $("input#add_post").livequery("click",function(){
        $("#with_post").slideToggle();
      });

      $("#add_document_label_link").click(function() {
        $("#new_attachment").effect("highlight", {color:"#F5DF51"}, 3000);
      });

      $("#attachment__tags").fcbkcomplete({
          cache: true,
                filter_case: false,
                filter_hide: true,
                firstselected: true,
                filter_selected: true,
                maxshownitems: 4,
                newel: true,
                complete_opts: true
        });

      // Action links
      $("a.repository_sidebar_action").livequery("click",function(){
        if($(this).hasClass("disabled_button")){
          return false;
        }else{
          collapse_tag_list();
          $.getScript(this.href);
          return false;
        }
      });

      //Multiple selectors actions

      selected_attachments = function(){
        var sa = new Array();
        $(".attachment_checkbox").each(function(){
          if($(this).attr('checked')){
            sa.push($(this).attr("value"));
          }
        });
        return sa;
      };

      can_delete_selected = function(){
        var can_delete = true
        $(".attachment_checkbox:checked").each(function(){
          if(!$(this).parents("tr.attachment").hasClass("can_delete")){
            can_delete = false;
          }
        });
        return can_delete;
      };

      update_selected = function(){
        var sa = selected_attachments();
        if(sa.length==0){
          $("#selected_info").html(I18n.t("attachment.selected.none"));
          $("#multiple_download").addClass("disabled_button");
          $("#multiple_delete").addClass("disabled_button");
        }else{
          if(sa.length==1){
            $("#selected_info").html(sa.length + ' ' + I18n.t("attachment.selected.one"));
          }else{
            $("#selected_info").html(sa.length + ' ' + I18n.t("attachment.selected.other"));
          }
          $("#multiple_download").removeClass("disabled_button");
          //Check permissions
          if(can_delete_selected()){
            $("#multiple_delete").removeClass("disabled_button");
          }else{
            $("#multiple_delete").addClass("disabled_button");
          }
        }
      }

      $(".attachment_checkbox").click(function(){
        update_selected();
      });

      $("#select_all_checkbox").click(function(){
        if($(this).attr("checked")){
          $(".attachment_checkbox").attr("checked", true);
        }else{
          $(".attachment_checkbox").attr("checked", false);
        }
        update_selected();
      });

      $("#multiple_download").click(function(){
        if($(this).hasClass("disabled_button")){
          return false;
        }else{
          var sa = selected_attachments();
          $(this).attr("href", gon.attachments_path + ".zip/" + "?attachment_ids=" + sa.join(","));
        }
      });

      $("#multiple_delete").click(function(){
        if($(this).hasClass("disabled_button")){
          return false;
        }else{
          if(confirm('Delete selected attachments?')){
            var sa = selected_attachments();
            var f = document.createElement('form');
            f.style.display = 'none';
            this.parentNode.appendChild(f);
            f.method = 'POST';
            f.action = gon.attachments_path + "?attachment_ids=" + sa.join(",");
            var m = document.createElement('input');
            m.setAttribute('type', 'hidden');
            m.setAttribute('name', '_method');
            m.setAttribute('value', 'delete');
            f.appendChild(m);
            var s = document.createElement('input');
            s.setAttribute('type', 'hidden');
            s.setAttribute('name', 'authenticity_token');
            s.setAttribute('value', gon.form_auth_token);
            f.appendChild(s);
            f.submit();
          }
          return false;
        }
      });

      //Initial actions
      $("#enable_javascript").hide();
      update_selected();
    });

= content_for :sidebar do
  .tag_filter_wrapper
    %h3{ :class => "blue" }
      = t('repository.search')
      = image_tag('icons/help.png', :title => t('tooltip.doc_search'), :size => "16x16", :class => "icon tooltipped upwards", :style => "cursor:pointer")
    .tag_filter_content
      = render :partial => 'mixed_filter'
    = render :partial => 'tag_filter'
  - if attachment.errors.any?
    = render :partial => 'upload_form'
  - else
    #doc_action
#enable_javascript
  = t('repository.need_javascript')
#doc_repository
  = render :partial => 'multiple_actions'
  = render :partial => 'doc_table'
